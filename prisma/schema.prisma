datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CivilStatus {
  SINGLE
  MARRIED
  WIDOWED
  SEPARATED
}

enum Department {
  ENGINEERING
  HR
  FINANCE
  SALES
  MARKETING
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

enum LeaveType {
  VACATION
  SICK_LEAVE
  EMERGENCY_LEAVE
  MATERNITY_LEAVE
  PATERNITY_LEAVE
  BEREAVEMENT_LEAVE
  UNPAID_LEAVE
  OTHER
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}


model User {
  id            String    @id @default(cuid())
  name          String
  email         String    @unique
  username      String    @unique
  password      String    // Hashed
  role          UserRole  @default(EMPLOYEE)
  avatarUrl     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  employee      Employee? @relation(fields: [employeeId], references: [id])
  employeeId    String?   @unique
  auditLogs     AuditLog[]
  
  // Approval relations
  leaveReviews         LeaveRequest[]        @relation("LeaveReviewer")
  overtimeReviews      OvertimeRequest[]     @relation("OvertimeReviewer")
  cashAdvanceManagerReviews CashAdvanceRequest[] @relation("CashAdvanceManagerApprover")
  cashAdvanceAdminReviews   CashAdvanceRequest[] @relation("CashAdvanceAdminApprover")
}

model Employee {
  id            String    @id // Custom ID like EMP-001
  firstName     String
  lastName      String
  middleName    String?
  email         String    @unique
  
  // Profile
  birthDate     DateTime
  age           Int?
  gender        Gender
  civilStatus   CivilStatus
  address       String
  contactNo     String
  avatarUrl     String?

  // Employment
  department    Department
  position      String
  status        EmployeeStatus @default(ACTIVE)
  dateHired     DateTime
  dateResigned  DateTime?
  workSchedule  String?

  // Compensation
  basicSalary   Float
  biMonthlySalary Float?
  ratePerHour   Float?
  ratePerDay    Float?

  // Government IDs
  sssNo         String?
  philHealthNo  String?
  pagIbigNo     String?
  tinNo         String?

  // Emergency Contact
  ecFullName    String?
  ecContactNo   String?
  ecRelation    String?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  user          User?
  attendance    Attendance[]
  payrolls      Payroll[]
  leaves        LeaveRequest[]
  overtimes     OvertimeRequest[]
  cashAdvances  CashAdvanceRequest[]
  loans         Loan[]
  documents     Document[]
}

model Attendance {
  id            String    @id @default(cuid())
  date          DateTime
  timeIn        DateTime?
  timeOut       DateTime?
  status        String    // PRESENT, LATE, ABSENT, HALF_DAY
  hoursWorked   Float     @default(0)
  overtimeHours Float     @default(0)
  
  employee      Employee  @relation(fields: [employeeId], references: [id])
  employeeId    String

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([employeeId, date])
}

model Payroll {
  id            String    @id @default(cuid())
  periodStart   DateTime
  periodEnd     DateTime
  payoutDate    DateTime?
  
  // Earnings
  basicPay      Float
  overtimePay   Float
  allowances    Float     @default(0)
  grossPay      Float

  // Deductions
  sssDeduction        Float
  philHealthDeduction Float
  pagIbigDeduction    Float
  taxDeduction        Float
  otherDeductions     Float     @default(0)
  totalDeductions     Float

  // Net
  netPay        Float

  // Employer Shares (Memo)
  erSSS         Float
  erPhilHealth  Float
  erPagIbig     Float

  status        String    // DRAFT, FINALIZED, PAID

  employee      Employee  @relation(fields: [employeeId], references: [id])
  employeeId    String

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model LeaveRequest {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  leaveType     LeaveType
  startDate     DateTime
  endDate       DateTime
  totalDays     Float     // Can be 0.5 for half-day
  reason        String
  
  status        RequestStatus @default(PENDING)
  
  // Approval chain
  reviewedById  String?
  reviewedBy    User?     @relation("LeaveReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  reviewNotes   String?
  
  // Attachments (e.g., medical certificate)
  attachmentUrl String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([status])
  @@index([startDate])
}

model OvertimeRequest {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  date          DateTime
  startTime     DateTime
  endTime       DateTime
  totalHours    Float
  reason        String
  projectTask   String?   // What they worked on
  
  status        RequestStatus @default(PENDING)
  
  // Approval chain
  reviewedById  String?
  reviewedBy    User?     @relation("OvertimeReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  reviewNotes   String?
  
  // Payroll integration
  overtimeRate  Float?    // Multiplier (e.g., 1.5x, 2.0x)
  overtimePay   Float?    // Calculated amount
  isPaid        Boolean   @default(false)
  paidInPayrollId String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([status])
  @@index([date])
}

model CashAdvanceRequest {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  amount        Float
  reason        String
  repaymentPlan String    // e.g., "3 months", "Next payroll"
  
  status        RequestStatus @default(PENDING)
  
  // Approval chain (may require multiple approvals)
  managerApproval      ApprovalStatus @default(PENDING)
  managerApprovedById  String?
  managerApprovedBy    User?     @relation("CashAdvanceManagerApprover", fields: [managerApprovedById], references: [id])
  managerApprovedAt    DateTime?
  managerNotes         String?
  
  adminApproval        ApprovalStatus @default(PENDING)
  adminApprovedById    String?
  adminApprovedBy      User?     @relation("CashAdvanceAdminApprover", fields: [adminApprovedById], references: [id])
  adminApprovedAt      DateTime?
  adminNotes           String?
  
  // Disbursement
  isDisbursed   Boolean   @default(false)
  disbursedAt   DateTime?
  disbursedBy   String?
  
  // Repayment tracking
  isFullyRepaid Boolean   @default(false)
  repaidAmount  Float     @default(0)
  remainingBalance Float
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([status])
}

model Loan {
  id            String    @id @default(cuid())
  type          String    // SSS, PAGIBIG, COMPANY
  principal     Float
  balance       Float
  monthlyAmort  Float
  status        String    // ACTIVE, PAID

  employee      Employee  @relation(fields: [employeeId], references: [id])
  employeeId    String

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Document {
  id            String    @id @default(cuid())
  name          String
  type          String
  url           String
  size          Int

  employee      Employee  @relation(fields: [employeeId], references: [id])
  employeeId    String

  uploadedAt    DateTime  @default(now())
}

model AuditLog {
  id            String    @id @default(cuid())
  action        String    // LOGIN, CREATE_EMPLOYEE, PROCESS_PAYROLL
  details       String?
  ipAddress     String?
  
  user          User?     @relation(fields: [userId], references: [id])
  userId        String?

  timestamp     DateTime  @default(now())
}
