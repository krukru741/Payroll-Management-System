generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id         String     @id @default(cuid())
  name       String
  email      String     @unique
  username   String     @unique
  password   String
  role       UserRole   @default(EMPLOYEE)
  avatarUrl  String?
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  employeeId String?    @unique
  auditLogs  AuditLog[]
  employee   Employee?  @relation(fields: [employeeId], references: [id])
  
  // Approval relations for Filing system
  leaveReviews         LeaveRequest[]        @relation("LeaveReviewer")
  overtimeReviews      OvertimeRequest[]     @relation("OvertimeReviewer")
  cashAdvanceManagerReviews CashAdvanceRequest[] @relation("CashAdvanceManagerApprover")
  cashAdvanceAdminReviews   CashAdvanceRequest[] @relation("CashAdvanceAdminApprover")
}

model Employee {
  id              String         @id
  firstName       String
  lastName        String
  middleName      String?
  email           String         @unique
  birthDate       DateTime
  age             Int?
  gender          Gender
  civilStatus     CivilStatus
  address         String
  contactNo       String
  avatarUrl       String?
  department      Department
  position        String
  status          EmployeeStatus @default(ACTIVE)
  dateHired       DateTime
  dateResigned    DateTime?
  basicSalary     Float
  ratePerHour     Float?
  ratePerDay      Float?
  sssNo           String?
  philHealthNo    String?
  pagIbigNo       String?
  tinNo           String?
  ecFullName      String?
  ecContactNo     String?
  ecRelation      String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  biMonthlySalary Float?
  workSchedule    String?
  attendance      Attendance[]
  documents       Document[]
  loans           Loan[]
  payrolls        Payroll[]
  user            User?
  
  // Filing system relations
  leaves        LeaveRequest[]
  overtimes     OvertimeRequest[]
  cashAdvances  CashAdvanceRequest[]
  leaveCredits  LeaveCredit[]
}

model LeaveCredit {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  leaveType     LeaveType
  credits       Float     // Total credits for this leave type
  
  // Audit trail
  adjustedBy    String?   // User ID who made the adjustment
  adjustedAt    DateTime  @default(now())
  reason        String?   // Reason for adjustment
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@unique([employeeId, leaveType])
  @@index([employeeId])
}

model Attendance {
  id            String    @id @default(cuid())
  date          DateTime
  timeIn        DateTime?
  timeOut       DateTime?
  status        String
  hoursWorked   Float     @default(0)
  overtimeHours Float     @default(0)
  employeeId    String
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  employee      Employee  @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
}

model Payroll {
  id                  String    @id @default(cuid())
  periodStart         DateTime
  periodEnd           DateTime
  payoutDate          DateTime?
  basicPay            Float
  overtimePay         Float
  allowances          Float     @default(0)
  grossPay            Float
  sssDeduction        Float
  philHealthDeduction Float
  pagIbigDeduction    Float
  taxDeduction        Float
  otherDeductions     Float     @default(0)
  totalDeductions     Float
  netPay              Float
  erSSS               Float
  erPhilHealth        Float
  erPagIbig           Float
  status              String
  employeeId          String
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  employee            Employee  @relation(fields: [employeeId], references: [id])
}

/// We could not retrieve columns for the underlying table. Either it has none or you are missing rights to see them. Please check your privileges.
// model LeaveRequest {
// }

/// We could not retrieve columns for the underlying table. Either it has none or you are missing rights to see them. Please check your privileges.
// model OvertimeRequest {
// }

/// We could not retrieve columns for the underlying table. Either it has none or you are missing rights to see them. Please check your privileges.
// model CashAdvanceRequest {
// }

model Loan {
  id           String   @id @default(cuid())
  type         String
  principal    Float
  balance      Float
  monthlyAmort Float
  status       String
  employeeId   String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  employee     Employee @relation(fields: [employeeId], references: [id])
}

model Document {
  id         String   @id @default(cuid())
  name       String
  type       String
  url        String
  size       Int
  employeeId String
  uploadedAt DateTime @default(now())
  employee   Employee @relation(fields: [employeeId], references: [id])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  details   String?
  ipAddress String?
  userId    String?
  timestamp DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

enum UserRole {
  ADMIN
  MANAGER
  EMPLOYEE
}

model SystemSettings {
  id        String   @id @default(cuid())
  category  String   @unique
  settings  Json
  updatedBy String?
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum CivilStatus {
  SINGLE
  MARRIED
  WIDOWED
  SEPARATED
}

enum Department {
  ADMIN
  ENGINEERING
  HR
  FINANCE
  SALES
  MARKETING
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
  ON_LEAVE
  TERMINATED
}

enum LeaveType {
  VACATION
  SICK_LEAVE
  EMERGENCY_LEAVE
  MATERNITY_LEAVE
  PATERNITY_LEAVE
  BEREAVEMENT_LEAVE
  UNPAID_LEAVE
  OTHER
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

model LeaveRequest {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  leaveType     LeaveType
  startDate     DateTime
  endDate       DateTime?     // Auto-calculated when employee clocks in
  totalDays     Float?        // Auto-calculated from start to end date
  reason        String
  
  status        RequestStatus @default(PENDING)
  
  // Auto-calculation fields
  isActive      Boolean   @default(false)  // True when leave is approved and ongoing
  completedAt   DateTime?                  // When leave was completed (clock-in or manual)
  completedBy   String?                    // User ID who completed (for manual completion)
  manualCompletion Boolean @default(false) // True if completed manually by manager/admin
  
  // Approval chain
  reviewedById  String?
  reviewedBy    User?     @relation("LeaveReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  reviewNotes   String?
  
  // Attachments (e.g., medical certificate)
  attachmentUrl String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([status])
  @@index([startDate])
  @@index([isActive])
}

model OvertimeRequest {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  date          DateTime
  startTime     DateTime
  endTime       DateTime?  // Auto-calculated when employee clocks out
  totalHours    Float?     // Auto-calculated from start to end time
  reason        String
  projectTask   String?    // What they worked on
  
  status        RequestStatus @default(PENDING)
  
  // Auto-calculation fields
  isActive      Boolean   @default(false)  // True when OT is approved and ongoing
  completedAt   DateTime?                  // When OT was completed (clock-out or manual)
  completedBy   String?                    // User ID who completed (for manual completion)
  manualCompletion Boolean @default(false) // True if completed manually by manager/admin
  isBackdated   Boolean   @default(false)  // True if filed after clock-out
  
  // Approval chain
  reviewedById  String?
  reviewedBy    User?     @relation("OvertimeReviewer", fields: [reviewedById], references: [id])
  reviewedAt    DateTime?
  reviewNotes   String?
  
  // Payroll integration
  overtimeRate  Float?    // Multiplier (e.g., 1.5x, 2.0x)
  overtimePay   Float?    // Calculated amount
  isPaid        Boolean   @default(false)
  paidInPayrollId String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([status])
  @@index([date])
  @@index([isActive])
}

model CashAdvanceRequest {
  id            String    @id @default(cuid())
  employeeId    String
  employee      Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  amount        Float
  reason        String
  repaymentPlan String    // e.g., "3 months", "Next payroll"
  
  status        RequestStatus @default(PENDING)
  
  // Approval chain (may require multiple approvals)
  managerApproval      ApprovalStatus @default(PENDING)
  managerApprovedById  String?
  managerApprovedBy    User?     @relation("CashAdvanceManagerApprover", fields: [managerApprovedById], references: [id])
  managerApprovedAt    DateTime?
  managerNotes         String?
  
  adminApproval        ApprovalStatus @default(PENDING)
  adminApprovedById    String?
  adminApprovedBy      User?     @relation("CashAdvanceAdminApprover", fields: [adminApprovedById], references: [id])
  adminApprovedAt      DateTime?
  adminNotes           String?
  
  // Disbursement
  isDisbursed   Boolean   @default(false)
  disbursedAt   DateTime?
  disbursedBy   String?
  
  // Repayment tracking
  isFullyRepaid Boolean   @default(false)
  repaidAmount  Float     @default(0)
  remainingBalance Float
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([employeeId])
  @@index([status])
}
